YUI.add("moodle-mod_dialogue-recipientpicker",function(e,t){var n=function(){n.superclass.constructor.apply(this,arguments)};n.NAME="recipientpicker",n.ATTRS={},e.extend(n,e.Base,{AutoComplete:{},resultRequiredFields:["id","fullname","picture","imagealt"],initializer:function(t){this.inputNode=t.inputNode||null;if(!e.one(this.inputNode))return!1;this.source=t.source||null,this.resultTextLocator=t.resultTextLocator||"fullname",this.resultListLocator=t.resultListLocator||"results",this.resultHighlighter="phraseMatch",this.maxResults=parseInt(t.maxResults,10)||10,this.resultFormatter=this.formatResultList,this.AutoComplete=new e.AutoComplete(this.getAutoCompleteConfig()),this.selectedNode=t.selectedNode||null,this.selectedHiddenName=t.selectedHiddenName||"rp-data",this.AutoComplete.on("query",e.bind(this.onQuery,this));if(!e.one(this.selectedNode))return new M.core.exception(new Error("selectedNode not found, must be defined!"));e.one(this.selectedNode).addClass("rp-selected-group"),this.AutoComplete.after("select",e.bind(this.onListItemSelected,this)),e.one(this.inputNode).on("focus",e.bind(this.onInputFocus,this)),e.one(this.inputNode).on("key",e.bind(this.onInputBackspace,this),"backspace");if(t.selectedItems)for(var n=0;n<t.selectedItems.length;n++)this.addSelectedItem(t.selectedItems[n]);this.AutoComplete.render()},onQuery:function(t){var n=e.all(".rp-selected-item");n.size()===1&&(t.preventDefault(),t.stopPropagation())},onItemRemove:function(e){var t=e.currentTarget.ancestor(".rp-selected-item");return t?t.remove():!1},onInputFocus:function(){var t=e.one(this.inputNode),n=e.all(".rp-selected-item");if(n.size()===1)return;t.get("value")===""&&this.AutoComplete.sendRequest("")},onInputBackspace:function(){var t=e.one(this.inputNode),n=e.one(this.selectedNode),r;r=n.one("> .rp-selected-item:last-of-type"),r&&t.get("value")===""&&r.remove()},onListItemSelected:function(e){var t=e.result.raw;this.addSelectedItem(t)},addSelectedItem:function(t){var n,r,i;r=e.one(this.selectedNode),i=e.one(this.inputNode);if(!(t instanceof Object))return;e.Array.each(this.resultRequiredFields,function(e){if(!t.hasOwnProperty(e))return new M.core.exception(new Error("Required field "+e+" not found!"))}),r&&(n=e.Node.create('<div class="rp-selected-item"></div>').append('<input type="hidden" name="'+this.selectedHiddenName+'[]" value="'+t.id+'"/>').append(e.Node.create('<img class="userpicture" src="'+t.imageurl+'" alt="'+t.imagealt+'" title="'+t.imagealt+'"/>')).append(e.Node.create('<span class="fullname">'+t.fullname+"</span>")).append(e.Node.create('<img class="rp-remove-action" src="'+M.util.image_url("remove","dialogue")+'"/>')),r.append(n),e.on("click",e.bind(this.onItemRemove,this),".rp-selected-group .rp-selected-item .rp-remove-action"),i.set("value",""))},getAutoCompleteConfig:function(e){var t=["inputNode","source","resultTextLocator","resultListLocator","resultHighlighter","maxResults","resultFormatter"],n={},r;if(e)r=t.indexOf(e),n=this[t[r]];else for(var i in t)n[t[i]]=this[t[i]];return n},formatResultList:function(t,n){return e.Array.map(n,function(t){var n=t.raw,r=e.Node.create('<div class="rp-result-item"></div>').append(e.Node.create('<img class="userpicture" src="'+n.imageurl+'" alt="'+n.imagealt+'" title="'+n.imagealt+'"/>')).append(e.Node.create('<span class="fullname">'+t.highlighted+"</span>"));return r})}}),M.mod_dialogue=M.mod_dialogue||{},M.mod_dialogue.recipientpicker=M.mod_dialogue.recipientpicker||{},M.mod_dialogue.recipientpicker.init=function(e){return new n(e)}},"@VERSION@",{requires:["base","node","node-event-delegate","json-parse","autocomplete","autocomplete-filters","autocomplete-highlighters","event","event-key","moodle-core-notification-exception"]});
